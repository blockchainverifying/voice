<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Radio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="text-center">
        <i class="fas fa-broadcast-tower text-6xl text-blue-400 mb-4"></i>
        <h1 class="text-3xl font-bold text-white">Connected to Radio</h1>
        <p id="status" class="text-lg text-gray-400 mt-2">Your camera feed is live for the admin.</p>
        
        <!-- Local video preview (optional, can be hidden) -->
        <video id="localVideo" autoplay muted playsinline class="w-48 h-auto rounded-lg mt-4 mx-auto border-2 border-slate-700"></video>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCwzPmWpDmx4SEPeZkvzcYLnOd4k6QLe2U",
            authDomain: "my-voice-app-4eca5.firebaseapp.com",
            projectId: "my-voice-app-4eca5",
            storageBucket: "my-voice-app-4eca5.appspot.com",
            messagingSenderId: "972654270500",
            appId: "1:972654270500:web:c29a42a09972f5a4ce20b1",
            databaseURL: "https://my-voice-app-4eca5-default-rtdb.firebaseio.com/"
        };

        // --- DOM Elements ---
        const statusEl = document.getElementById('status');
        const localVideo = document.getElementById('localVideo');

        // --- App State ---
        let db, rtdb;
        let myId = null;
        let privateConnection;
        let myStream;

        // --- Main Initialization ---
        async function initialize() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);
            rtdb = getDatabase(app);

            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true });
                localVideo.srcObject = myStream;
            } catch (e) {
                console.error("Could not get media stream:", e);
                statusEl.textContent = "Please allow camera access.";
                return;
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    myId = user.uid;
                    setupPresence();
                    listenForPrivateCalls();
                }
            });

            await signInAnonymously(auth);
        }
        
        function setupPresence() {
            const myStatusRef = ref(rtdb, 'status/' + myId);
            const isOfflineForRTDB = { state: 'offline' };
            const isOnlineForRTDB = { state: 'online' };

            onValue(ref(rtdb, '.info/connected'), (snapshot) => {
                if (snapshot.val() === false) return;
                onDisconnect(myStatusRef).set(isOfflineForRTDB).then(() => {
                    set(myStatusRef, isOnlineForRTDB);
                });
            });
        }

        function listenForPrivateCalls() {
            const offerRef = doc(db, 'webrtc_calls', myId);
            onSnapshot(offerRef, async (snapshot) => {
                if (snapshot.exists()) {
                    const { offer } = snapshot.data();
                    if (offer) {
                        if (privateConnection) privateConnection.close();
                        
                        const pc = new RTCPeerConnection();
                        privateConnection = pc;
                        
                        myStream.getTracks().forEach(track => pc.addTrack(track, myStream));
                        
                        pc.onconnectionstatechange = () => {
                            if (['disconnected', 'failed', 'closed'].includes(pc.connectionState)) {
                                deleteDoc(offerRef);
                            }
                        };
                        
                        await pc.setRemoteDescription(new RTCSessionDescription(offer));
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        await updateDoc(offerRef, { answer });
                    }
                } else {
                    if (privateConnection) {
                        privateConnection.close();
                        privateConnection = null;
                    }
                }
            });
        }
        
        initialize();
    </script>
</body>
</html>
