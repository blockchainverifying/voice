<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Radio Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-card {
            background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .video-card {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-gray-900 text-white min-h-screen p-4">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6">Radio Admin Panel</h1>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Admin Controls -->
            <div class="lg:col-span-1 glass-card p-6 rounded-2xl h-fit">
                <h2 class="text-xl font-bold mb-4">Admin Controls</h2>
                <div class="space-y-4">
                    <div>
                        <button id="shareScreenBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 rounded-lg py-2 font-semibold flex items-center justify-center">
                            <i class="fas fa-desktop mr-2"></i>
                            <span>Share System Audio</span>
                        </button>
                    </div>
                    <div>
                        <label for="notificationText" class="block text-sm font-medium text-gray-300 mb-1">Send Notification</label>
                        <textarea id="notificationText" rows="3" class="w-full p-2 bg-slate-700 rounded-lg border border-slate-600" placeholder="Type notification text..."></textarea>
                        <button id="sendNotificationBtn" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 rounded-lg py-2 font-semibold">Send & Speak</button>
                    </div>
                    <div class="pt-4">
                         <h3 class="text-lg font-bold mb-2">My Audio Stream</h3>
                         <audio id="localAudio" muted autoplay playsinline class="w-full rounded-lg"></audio>
                    </div>
                     <div>
                        <h3 class="text-lg font-bold mb-2">Live Users: <span id="userCount">0</span></h3>
                    </div>
                </div>
            </div>

            <!-- Video Grid -->
            <div class="lg:col-span-3 glass-card p-6 rounded-2xl">
                <h2 class="text-xl font-bold mb-4">Live Camera Feeds</h2>
                <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
                    <!-- Live feeds will be populated here -->
                </div>
            </div>

        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, updateDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCwzPmWpDmx4SEPeZkvzcYLnOd4k6QLe2U",
            authDomain: "my-voice-app-4eca5.firebaseapp.com",
            projectId: "my-voice-app-4eca5",
            storageBucket: "my-voice-app-4eca5.appspot.com",
            messagingSenderId: "972654270500",
            appId: "1:972654270500:web:c29a42a09972f5a4ce20b1",
            databaseURL: "https://my-voice-app-4eca5-default-rtdb.firebaseio.com/"
        };

        // --- DOM Elements ---
        const videoGridEl = document.getElementById('video-grid');
        const userCountEl = document.getElementById('userCount');
        const notificationText = document.getElementById('notificationText');
        const sendNotificationBtn = document.getElementById('sendNotificationBtn');
        const localAudio = document.getElementById('localAudio');
        const shareScreenBtn = document.getElementById('shareScreenBtn');
        
        // --- App State ---
        let db, auth, rtdb;
        let adminMicStream, adminScreenStream;
        let currentAdminStream;
        let peerConnections = {}; 
        let broadcastPc;

        // --- Main Initialization ---
        async function initialize() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            rtdb = getDatabase(app);
            await signInAnonymously(auth);

            adminMicStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            currentAdminStream = adminMicStream;
            localAudio.srcObject = currentAdminStream;
            
            await setupAdminBroadcast();
            listenToUsers();

            sendNotificationBtn.addEventListener('click', sendNotification);
            shareScreenBtn.addEventListener('click', toggleScreenShare);
        }

        function listenToUsers() {
            const statusRef = ref(rtdb, 'status/');
            onValue(statusRef, (snapshot) => {
                const users = snapshot.val() || {};
                const onlineUsers = new Set();
                
                for (const userId in users) {
                    if (users[userId].state === 'online') {
                        onlineUsers.add(userId);
                    }
                }
                userCountEl.textContent = onlineUsers.size;

                onlineUsers.forEach(userId => {
                    if (!peerConnections[userId]) {
                        connectToUser(userId);
                    }
                });

                Object.keys(peerConnections).forEach(userId => {
                    if (!onlineUsers.has(userId)) {
                        disconnectFromUser(userId);
                    }
                });
            });
        }
        
        function addUserVideoUI(userId) {
            if (document.getElementById(`video_card_${userId}`)) return;
            const videoCard = document.createElement('div');
            videoCard.id = `video_card_${userId}`;
            videoCard.className = 'video-card bg-slate-800 rounded-lg overflow-hidden shadow-lg';
            videoCard.innerHTML = `
                <video id="video_${userId}" autoplay playsinline class="w-full h-auto aspect-video bg-black"></video>
                <div class="p-2">
                    <p class="text-sm font-semibold">User-${userId.substring(0, 6)}</p>
                    <button data-userid="${userId}" class="toggle-listen-btn mt-1 w-full bg-green-600 hover:bg-green-700 px-2 py-1 text-xs rounded">Allow Listen</button>
                </div>
            `;
            videoGridEl.appendChild(videoCard);
            videoCard.querySelector('.toggle-listen-btn').addEventListener('click', (e) => toggleUserListen(userId, e.target));
        }
        
        function removeUserVideoUI(userId) {
            const videoCard = document.getElementById(`video_card_${userId}`);
            if (videoCard) videoCard.remove();
        }

        async function connectToUser(userId) {
            addUserVideoUI(userId);
            const pc = new RTCPeerConnection();
            peerConnections[userId] = pc;

            pc.ontrack = (event) => {
                const videoEl = document.getElementById(`video_${userId}`);
                if (videoEl) videoEl.srcObject = event.streams[0];
            };
            
            pc.onconnectionstatechange = () => {
                if (['disconnected', 'failed', 'closed'].includes(pc.connectionState)) {
                    disconnectFromUser(userId);
                }
            };

            const offer = await pc.createOffer({ offerToReceiveVideo: 1, offerToReceiveAudio: 1 });
            await pc.setLocalDescription(offer);

            const offerRef = doc(db, 'private_calls', userId);
            await setDoc(offerRef, { offer });

            onSnapshot(offerRef, (snapshot) => {
                const data = snapshot.data();
                if (data && data.answer && pc.signalingState !== 'stable') {
                    pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });
        }
        
        function disconnectFromUser(userId) {
            if (peerConnections[userId]) {
                peerConnections[userId].close();
                delete peerConnections[userId];
            }
            removeUserVideoUI(userId);
            deleteDoc(doc(db, 'private_calls', userId));
        }

        async function toggleUserListen(userId, button) {
            const userPermissionRef = doc(db, 'permissions', userId);
            const docSnap = await getDoc(userPermissionRef);
            const canListen = !(docSnap.exists() && docSnap.data().canListen);
            await setDoc(userPermissionRef, { canListen });
            button.textContent = canListen ? 'Mute User' : 'Allow Listen';
            button.classList.toggle('bg-green-600', !canListen);
            button.classList.toggle('bg-red-600', canListen);
        }
        
        async function setupAdminBroadcast() {
            broadcastPc = new RTCPeerConnection();
            currentAdminStream.getTracks().forEach(track => broadcastPc.addTrack(track, currentAdminStream));
            const offer = await broadcastPc.createOffer();
            await broadcastPc.setLocalDescription(offer);
            const broadcastRef = doc(db, 'broadcast', 'admin_offer');
            await setDoc(broadcastRef, { offer });
        }

        function replaceBroadcastTrack(newStream) {
            currentAdminStream = newStream;
            const audioTrack = newStream.getAudioTracks()[0];
            const sender = broadcastPc.getSenders().find(s => s.track && s.track.kind === 'audio');
            if (sender) {
                sender.replaceTrack(audioTrack);
            }
        }

        async function toggleScreenShare() {
            if (adminScreenStream) { // Agar screen share on hai
                replaceBroadcastTrack(adminMicStream);
                adminScreenStream.getTracks().forEach(track => track.stop());
                adminScreenStream = null;
                shareScreenBtn.innerHTML = '<i class="fas fa-desktop mr-2"></i><span>Share System Audio</span>';
            } else { // Agar screen share off hai
                adminScreenStream = await navigator.mediaDevices.getDisplayMedia({ audio: true });
                replaceBroadcastTrack(adminScreenStream);
                shareScreenBtn.innerHTML = '<i class="fas fa-stop-circle mr-2"></i><span>Stop Sharing</span>';
                adminScreenStream.getTracks()[0].onended = () => toggleScreenShare();
            }
        }
        
        async function sendNotification() {
            const text = notificationText.value.trim();
            if (!text) return;
            const notificationRef = doc(db, 'notifications', 'latest');
            await setDoc(notificationRef, { text, timestamp: Date.now() });
            notificationText.value = '';
        }

        initialize();
    </script>
</body>
</html>
